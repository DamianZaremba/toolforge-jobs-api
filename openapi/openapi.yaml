# yaml-language-server: $schema=https://json-schema.org/draft/2020-12/schema
---
openapi: "3.1.0"
info:
  title: "Toolforge jobs framework API"
  version: "4.8.0"
servers:
  - url: "http://127.0.0.1:8000"
    description: "Local direct development server."
  - url: "https://127.0.0.1:3000/jobs"
    description: "Lima-kilo development server."
  - url: "https://api.svc.tools.eqiad1.wikimedia.cloud:30003/jobs"
    description: "Toolforge internal API gateway endpoint."
  - url: "https://api.svc.toolsbeta.eqiad1.wikimedia.cloud:30003/jobs"
    description: "Toolforge beta internal API gateway endpoint."
paths:
  /v1/tool/{toolname}/images:
    get:
      operationId: "images"
      description: "Returns the list of available container images that you can use to create a new job."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "The response contains a list of available container images."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageListResponse"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
  /v1/tool/{toolname}/quotas:
    get:
      operationId: "quotas"
      description: "Returns information on the tool account quotas in Toolforge."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "The response contains the quota details."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaResponse"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
  /v1/tool/{toolname}/jobs:
    get:
      operationId: "list"
      description: "Returns the list of jobs defined for this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
        - name: include_unset
          in: query
          description: "If unset or `true`, include all the fields including those that were not passed on job creation."
          required: false
          schema:
            default: true
            type: boolean
      responses:
        "200":
          description: "The list of jobs is returned."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobListResponse"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
    post:
      operationId: "create"
      description: "Create a new job in this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          "application/json":
            schema:
              oneOf:
                - $ref: "#/components/schemas/NewOneOffJob"
                - $ref: "#/components/schemas/NewScheduledJob"
                - $ref: "#/components/schemas/NewContinuousJob"
              ## TODO: Uncomment once job_type is enforced everywhere
              # discriminator:
              #   propertyName: job_type
              #   mapping:
              #      one-off: "#/components/schemas/NewOneOffJob"
              #      scheduled: "#/components/schemas/NewScheduledJob"
              #      continuous: "#/components/schemas/NewContinuousJob"
      responses:
        "200":
          description: "A new job was created."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobResponse"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
    patch:
      operationId: "update"
      description: "Updates an existing job or creates a new job for this Toolforge tool account"
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          "application/json":
            schema:
              oneOf:
                - $ref: "#/components/schemas/NewOneOffJob"
                - $ref: "#/components/schemas/NewScheduledJob"
                - $ref: "#/components/schemas/NewContinuousJob"
              ## TODO: Uncomment once job_type is enforced everywhere
              # discriminator:
              #   propertyName: job_type
              #   mapping:
              #      one-off: "#/components/schemas/NewOneOffJob"
              #      scheduled: "#/components/schemas/NewScheduledJob"
              #      continuous: "#/components/schemas/NewContinuousJob"
      responses:
        "200":
          description: "Operation was successful"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateResponse"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
    delete:
      operationId: "flush"
      description: "Stop and delete all defined jobs from this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "All jobs were flushed"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlushResponse"
        "401":
          $ref: "#/components/responses/unauthorized_error"
      security:
        - key: []
  /v1/tool/{toolname}/jobs/{id}:
    get:
      operationId: "show"
      description: "Show information about a given job for this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: "Job name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "Job was found."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobResponse"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
        "404":
          $ref: "#/components/responses/not_found_error"
      security:
        - key: []
    delete:
      operationId: "delete"
      description: "Stop and delete the specified job from this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: "Job name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "Job was deleted."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
        "404":
          $ref: "#/components/responses/not_found_error"
      security:
        - key: []
  /v1/tool/{toolname}/jobs/{id}/logs:
    get:
      operationId: "get_logs"
      description: "Get logs for a given job in this Toolforge tool account."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: "Job name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "Job logs are served."
          content:
            text/plain:
              schema:
                $ref: "#/components/schemas/JobLogs"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
        "404":
          $ref: "#/components/responses/not_found_error"
      security:
        - key: []
  /v1/tool/{toolname}/jobs/{id}/restart:
    post:
      operationId: "restart"
      description: "Restart a given job. If the job is a cronjob, execute it right now."
      parameters:
        - name: toolname
          in: path
          description: "Tool name."
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: "Job name."
          required: true
          schema:
            type: string
      responses:
        "200":
          description: "Job has been restarted."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RestartResponse"
        "400":
          $ref: "#/components/responses/bad_parameters_error"
        "401":
          $ref: "#/components/responses/unauthorized_error"
        "404":
          $ref: "#/components/responses/not_found_error"
      security:
        - key: []
  /openapi.json:
    get:
      operationId: "openapi"
      description: "Endpoint to access this openapi definition document."
      responses:
        "200":
          description: "Returns the openapi definition."
          content:
            application/json:
              schema:
                type: object
      security: []
  /v1/healthz:
    get:
      operationId: "healthcheck"
      description: "Endpoint that can be used to know the health status of the API itself."
      responses:
        "200":
          description: "The health status of the service is well known."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
      security: []
  /v1/metrics:
    get:
      operationId: "metrics"
      description: "Endpoint that exposes Prometheus metrics for the API."
      responses:
        "200":
          description: "Prometheus metrics are returned."
          content:
            text/plain:
              schema:
                type: string
      security: []
components:
  schemas:
    ResponseMessages:
      type: object
      description: |
        Lists of messages by priority, note that there will be a warning here when the endpoint is being deprecated
        with information on how to proceed to update it.
      properties:
        info:
          type: array
          items:
            type: string
        warning:
          type: array
          items:
            type: string
        error:
          type: array
          items:
            type: string
    ImageListResponse:
      type: object
      properties:
        images:
          type: array
          items:
            $ref: "#/components/schemas/Image"
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    QuotaResponse:
      type: object
      properties:
        quota:
          $ref: "#/components/schemas/Quota"
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    JobListResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            oneOf:
              - $ref: "#/components/schemas/DefinedOneOffJob"
              - $ref: "#/components/schemas/DefinedScheduledJob"
              - $ref: "#/components/schemas/DefinedContinuousJob"
            ## TODO: Uncomment once job_type is enforced everywhere
            # discriminator:
            #   propertyName: job_type
            #   mapping:
            #      one-off: "#/components/schemas/DefinedOneOffJob"
            #      scheduled: "#/components/schemas/DefinedScheduledJob"
            #      continuous: "#/components/schemas/DefinedContinuousJob"
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    JobResponse:
      type: object
      properties:
        job:
          oneOf:
            - $ref: "#/components/schemas/DefinedOneOffJob"
            - $ref: "#/components/schemas/DefinedScheduledJob"
            - $ref: "#/components/schemas/DefinedContinuousJob"
          ## TODO: Uncomment once job_type is enforced everywhere
          # discriminator:
          #   propertyName: job_type
          #   mapping:
          #      one-off: "#/components/schemas/DefinedOneOffJob"
          #      scheduled: "#/components/schemas/DefinedScheduledJob"
          #      continuous: "#/components/schemas/DefinedContinuousJob"
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    RestartResponse:
      type: object
      properties:
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    DeleteResponse:
      type: object
      properties:
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    UpdateResponse:
      type: object
      properties:
        messages:
          $ref: "#/components/schemas/ResponseMessages"
        job_changed:
          type: boolean
    FlushResponse:
      type: object
      properties:
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    HealthResponse:
      type: object
      properties:
        health:
          $ref: "#/components/schemas/Health"
        messages:
          $ref: "#/components/schemas/ResponseMessages"
    Health:
      type: object
      properties:
        status:
          type: string
          enum:
            - OK
            - ERROR
        message:
          type: string
    Image:
      type: object
      properties:
        shortname:
          type: string
        image:
          type: string
        state:
          type: string
        aliases:
          type: array
          items:
            type: string
        extras:
          type: object
          additionalProperties: true
    Quota:
      type: object
      properties:
        categories:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              items:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    limit:
                      type: string
                    used:
                      type: string
    JobLogs:
      type: string
    HealthCheckType:
      type: string
      enum:
        - script
        - http
    ScriptHealthCheck:
      type: object
      description: "Health check implemented as a script that runs inside the container"
      required:
        - type
        - script
      properties:
        type:
          $ref: "#/components/schemas/HealthCheckType"
        script:
          type: string
    HttpHealthCheck:
      type: object
      description: "Health check implemented as an HTTP request inside the container"
      required:
        - type
        - path
      properties:
        type:
          $ref: "#/components/schemas/HealthCheckType"
        path:
          type: string
    EmailOption:
      type: string
      description: "job emails setting."
      enum:
        - none
        - all
        - onfinish
        - onfailure
      example: "all"
    CommonJob:
      type: object
      required:
        - name
        - cmd
        - imagename
      properties:
        name:
          type: string
          description: "Unique name that identifies the job."
          # This is a restriction by Kubernetes:
          # a lowercase RFC 1123 subdomain must consist of lower case alphanumeric
          # characters, '-' or '.', and must start and end with an alphanumeric character
          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?([.][a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
          minLength: 1
          maxLength: 52
          example: "my-job"
        imagename:
          type: string
          description: "Container image the job uses."
          example: "tool-my-tool/tool-my-tool:latest"
        cmd:
          type: string
          description: "Command that this job is executing."
          example: "./some-command.sh --with-args"
        filelog:
          type: boolean
          description: "Whether this job uses filelog or not."
          example: false
          default: false
        filelog_stdout:
          type:
            - string
            - "null"
          description: "Path to the stdout file log."
          example: "logs/my-job.out"
        filelog_stderr:
          type:
            - string
            - "null"
          description: "Path to the stderr file log."
          example: "logs/my-job.err"
        emails:
          $ref: "#/components/schemas/EmailOption"
        retry:
          type: integer
          description: "Job retry policy. Zero means don't retry at all (the default)"
          minimum: 0
          maximum: 5
          example: 0
          default: 0
        mount:
          type: string
          description: "NFS mount configuration for the job."
          enum:
            - "all"
            - "none"
          example: "none"
          default: "all"
        memory:
          type:
            - string
            - "null"
          description: "Job memory resource limit."
          example: "1G"
        cpu:
          type:
            - string
            - "null"
          description: "Job CPU resource limit."
          example: "1"
    NewOneOffJob:
      allOf:
        - $ref: "#/components/schemas/CommonJob"
        - type: object
          # TODO: uncomment required when all clients have been migrated to job_type
          # required:
          #   - job_type
          properties:
            job_type:
              type: string
              enum: ["one-off"]
    NewScheduledJob:
      allOf:
        - $ref: "#/components/schemas/CommonJob"
        - type: object
          required:
            - schedule
            # TODO: uncomment required when all clients have been migrated to job_type
            # - job_type
          properties:
            job_type:
              type: string
              enum: ["scheduled"]
            schedule:
              type: string
              description: "If the job is a cronjob, execution schedule."
              example: "@hourly"
            timeout:
              type:
                - integer
                - "null"
              description: "Maximum amount of seconds the job will be allowed to run before it is failed"
              minimum: 0
              example: 120
    NewContinuousJob:
      allOf:
        - $ref: "#/components/schemas/CommonJob"
        - type: object
          # TODO: uncomment required when all clients have been migrated to job_type
          # required:
          #   - job_type
          properties:
            continuous: # TODO: For backward compatibility. Remove when every client using this api starts using job_ype
              type: boolean
              description: |
                If a job should be always running.
                This is deprecated and is only here for backward compatibility.
                Use job_type instead.
              example: true
            job_type:
              type: string
              enum: ["continuous"]
            replicas:
              type:
                - integer
                - "null"
              description: "Number of replicas to be used for the job"
              minimum: 1
              example: 1
            port:
              type:
                - integer
                - "null"
              description: "Port to expose for the job"
              minimum: 1
              maximum: 65535
              example: 8080
            port_protocol:
              type: string
              enum:
                - "tcp"
                - "udp"
              description: "Protocol for the port exposed by the job"
              example: "tcp"
              default: "tcp"
            publish:
              type: boolean
              description: "Expose this job to the internet via https://{toolname}.toolforge.org. If port is not specified, defaults to 8000. Only one job per tool can be published."
              default: false
              example: false
            health_check:
              type:
                - object
                - "null"
              description: "Health check configuration for the job"
              oneOf:
                - $ref: "#/components/schemas/ScriptHealthCheck"
                - $ref: "#/components/schemas/HttpHealthCheck"
              discriminator:
                propertyName: type
                mapping:
                  script: "#/components/schemas/ScriptHealthCheck"
                  http: "#/components/schemas/HttpHealthCheck"
    DefinedCommonJob:
      allOf:
        - $ref: "#/components/schemas/CommonJob"
        - type: object
          properties:
            image:
              type: string
              description: "Container image the job uses."
              example: "tool-my-tool/tool-my-tool:latest"
            image_state:
              type: string
              description: "Information about the image state, i.e, if it is stable, deprecated, or something else."
              example: "stable"
            status_short:
              type: string
              description: "Job status, short text."
              example: "Running."
            status_long:
              type: string
              description: "Job status, extended text."
              example: "Running since 30 seconds ago."
    DefinedOneOffJob:
      allOf:
        - $ref: "#/components/schemas/DefinedCommonJob"
        - type: object
          required:
            - job_type
          properties:
            job_type:
              type: string
              enum: ["one-off"]
    DefinedScheduledJob:
      allOf:
        - $ref: "#/components/schemas/DefinedCommonJob"
        - type: object
          required:
            - schedule
            - job_type
          properties:
            job_type:
              type: string
              enum: ["scheduled"]
            schedule:
              type: string
              description: "If the job is a cronjob, execution schedule."
              example: "@hourly"
            schedule_actual:
              type: string
              description: "If the job is a cronjob, actual execution schedule."
              example: "15 * * * *"
            timeout:
              type:
                - integer
                - "null"
              description: "Maximum amount of seconds the job will be allowed to run before it is failed"
              minimum: 0
              example: 120
    DefinedContinuousJob:
      allOf:
        - $ref: "#/components/schemas/DefinedCommonJob"
        - type: object
          required:
            - job_type
          properties:
            continuous: # TODO: For backward compatibility. Remove when every client using this api starts using job_ype
              type: boolean
              description: |
                If a job should be always running.
                This is deprecated and is only here for backward compatibility.
                Use job_type instead.
              example: true
            job_type:
              type: string
              enum: ["continuous"]
            replicas:
              type:
                - integer
                - "null"
              description: "Number of replicas to be used for the job"
              minimum: 1
              example: 1
            port:
              type:
                - integer
                - "null"
              description: "Port to expose for the job"
              minimum: 1
              maximum: 65535
              example: 8080
            port_protocol:
              type: string
              enum:
                - "tcp"
                - "udp"
              description: "Protocol for the port exposed by the job"
              example: "tcp"
            publish:
              type: boolean
              description: "Indicates if this job is exposed to the internet via https://{toolname}.toolforge.org."
              default: false
              example: false
            health_check:
              type:
                - object
                - "null"
              description: "Health check configuration for the job"
              oneOf:
                - $ref: "#/components/schemas/ScriptHealthCheck"
                - $ref: "#/components/schemas/HttpHealthCheck"
              discriminator:
                propertyName: type
                mapping:
                  script: "#/components/schemas/ScriptHealthCheck"
                  path: "#/components/schemas/HttpHealthCheck"
  responses:
    unauthorized_error:
      description: "Unauthorized error."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ResponseMessages"
    bad_parameters_error:
      description: "Bad parameters error"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ResponseMessages"
    not_found_error:
      description: "Object not found error."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ResponseMessages"
  securitySchemes:
    key:
      type: apiKey
      name: X-Toolforge-Tool
      in: header
