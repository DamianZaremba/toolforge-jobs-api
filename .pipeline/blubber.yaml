# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.12.1
version: v4
base: docker-registry.wikimedia.org/python3-bullseye:latest
variants:
  image:
    lives:
      in: /app
    apt:
      packages: [uwsgi-plugin-python3]
    builders:
      - custom:
          command:
            - mkdir
            - -p
            - prometheus-multiproc
      - python:
          version: "python3"
          requirements: ["requirements.txt"]
    runs:
      # needed for prometheus to write things
      insecurely: true
      environment:
        PROMETHEUS_MULTIPROC_DIR: /app/prometheus-multiproc
    copies:
      - local
    entrypoint:
      - uwsgi
      - --socket=127.0.0.1:8000
      - --plugin=python3
      - --mount=/=api:app
      - --master
      - --workers=4
