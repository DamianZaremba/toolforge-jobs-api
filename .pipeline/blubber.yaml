# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.12.1
version: v4
base: docker-registry.wikimedia.org/python3-bullseye:latest
variants:
  image:
    lives:
      in: /app
    builders:
      - custom:
          command:
            - mkdir
            - -p
            - prometheus-multiproc
      - python:
          version: "python3"
          requirements: ["requirements.txt"]
    runs:
      # needed to read k8s credentials from tool home dirs
      insecurely: true
      environment:
        PROMETHEUS_MULTIPROC_DIR: /app/prometheus-multiproc
    copies:
      - local
    entrypoint:
      - gunicorn
      - --bind=127.0.0.1:8000
      - --workers=4
      - --config=config.py
      - api:app
