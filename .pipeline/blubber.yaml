# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.21.1
version: v4
base: docker-registry.wikimedia.org/python3-bookworm:latest
variants:
  image:
    lives:
      in: /app
    builders:
      - custom:
          command:
            - mkdir
            - -p
            - prometheus-multiproc
      - python:
          version: python3
          poetry:
            version: ==1.7.1
          requirements:
            - pyproject.toml
            - poetry.lock
    runs:
      # needed to read k8s credentials from tool home dirs
      insecurely: true
      environment:
        PROMETHEUS_MULTIPROC_DIR: "/app/prometheus-multiproc"
        PORT: "8000"
        ADDRESS: "0.0.0.0"
    copies:
      - local
    entrypoint:
      - poetry
      - run
      - gunicorn
      - --workers=4
      - --config=config.py
      - api:app
