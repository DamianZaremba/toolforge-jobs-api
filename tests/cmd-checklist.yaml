---
- envvars:
    - CURL_URL: "https://localhost:30003/jobs/api/v1"
      CURL_ARGS: "--cert ~/.toolforge-lima-kilo/chroot/data/project/tf-test/.toolskube/client.crt --key ~/.toolforge-lima-kilo/chroot/data/project/tf-test/.toolskube/client.key -k"
      JOBNAME: "normaljob"
      SLEEP_CMD: ./sleep40.sh
      CRONJOBNAME: "cronjob"
      CONTJOBNAME: "continuousjob"
      # this must have state: stable
      IMG: "bookworm"
      KUBECTL_ARGS: -n tool-tf-test
      LOG_JOB: logjob
      CUSTOM_LOG_FILE: custom-log-file
      LOG_JOB_CMD: log.sh
      TOOLHOME: ~/.toolforge-lima-kilo/chroot/data/project/tf-test
---
- name: "flush everything"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/ ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: rm -f ${TOOLHOME}/${LOG_JOB_CMD}
      retcode: 0
    - cmd: rm -f ${TOOLHOME}/${LOG_JOB}*
      retcode: 0
    - cmd: rm -f ${TOOLHOME}/${CUSTOM_LOG_FILE}*
      retcode: 0

#
# job name validation
#
- name: invalid job names aren't allowed when running a new job
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "./wrongname"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 22
      stdout: ""
      stderr: ""
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "wrong_name"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 22
      stdout: ""
      stderr: ""
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "wrongname@"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 22
      stdout: ""
      stderr: ""
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "Wrongname"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 22
      stdout: ""
      stderr: ""

- name: when deleting a job with an invalid name, it is ignored
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/wrong.name ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/wrong_name ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

- name: can't show a job with an invalid name
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/invalid_name ${CURL_ARGS} -f
      retcode: 22
      stdout: ""
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/invalid.name ${CURL_ARGS} -f
      retcode: 22
      stdout: ""
      stderr: ""

#
# normal job
#

- name: "create normal job"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""

- name: "create duplicated normal job should fail"
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      # the server returns 500 (because k8s returns 409) and curl returns 22
      retcode: 22
      stdout: ""
      stderr: ""

- name: "show normal job, all fields are present"
  tests:
    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${JOBNAME} ${CURL_ARGS})
            echo "$response" | grep -q '"name": "${JOBNAME}"' \
            && echo "$response" | grep -q '"cmd": "${SLEEP_CMD}"' \
            && echo "$response" | grep -q '"image": "${IMG}"' \
            && echo "$response" | grep -q '"image_state": "stable"' \
            && echo "$response" | grep -q '"filelog": "False"' \
            && echo "$response" | grep -q '"filelog_stdout": null' \
            && echo "$response" | grep -q '"filelog_stderr": null' \
            && echo "$response" | grep -q '"retry": 0' \
            && echo "$response" | grep -q "status_short" \
            && echo "$response" | grep -q "status_long" \
            && echo "$response" | grep -q '"emails": "none"'
      retcode: 0
      stdout: ""
      stderr: ""

- name: "list jobs, only normal job is present"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | grep status_short | wc -l
      retcode: 0
      stdout: "1"
      stderr: ""

- name: "delete normal job"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${JOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

- name: "show normal job should fail because we just deleted it"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/${JOBNAME} ${CURL_ARGS} -f
      # this means the server returned 404
      retcode: 22
      stdout: ""
      stderr: ""
      retry_attempts: 10

- name: "create 2 normal jobs"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}2"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""
    # give k8s a chance to do its thing
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10

- name: delete 2 normal jobs one by one
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${JOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    # give k8s a chance to do its thing
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "2"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${JOBNAME}2" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

#
# retried job
#

- name: "create retried job with with retry not within acceptable values should fail"
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
        retry: 10
      # the server returns HTTP 400 and curl returns 22
      retcode: 22
      stdout: ""
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "0"
      stderr: ""


- name: "create retried job"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
        retry: 4
      retcode: 0
      stdout: ""
      stderr: ""

- name: "show retried job (check the 'retry' property)"
  tests:
    - cmd: |
            curl -s ${CURL_URL}/jobs/${JOBNAME} ${CURL_ARGS} | grep -q '"retry": 4'
      retcode: 0
      stdout: ""
      stderr: ""

- name: "list jobs (check the 'retry' property)"
  tests:
    - cmd: |
            curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | grep '"retry": 4' | wc -l
      retcode: 0
      stdout: "1"
      stderr: ""

- name: "delete retried job"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${JOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

- name: "show retried job should fail because we just deleted it"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/${JOBNAME} ${CURL_ARGS} -f
      # this means the server returned 404
      retcode: 22
      stdout: ""
      stderr: ""
      retry_attempts: 10

#
# cronjobs
#

- name: "create cronjob"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CRONJOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
        schedule: "*/10 * * * *"
      retcode: 0
      stdout: ""
      stderr: ""

- name: "list jobs, only cronjob is present"
  tests:
    # trailing echo helps with stdout comparision
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp
      retcode: 0
      stdout: >-
       [
          {
             "cmd" : "./sleep40.sh",
             "emails" : "none",
             "filelog" : "False",
             "filelog_stderr" : null,
             "filelog_stdout" : null,
             "image" : "bookworm",
             "image_state" : "stable",
             "name" : "cronjob",
             "retry" : 0,
             "schedule" : "*/10 * * * *",
             "schedule_actual" : "*/10 * * * *",
             "status_long" : "No pods were created for this job.",
             "status_short" : "Waiting for scheduled time"
          }
       ]
      stderr: ""
      retry_attempts: 10

- name: "create duplicated cronjob should fail"
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "${CRONJOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
        schedule: "*/10 * * * *"
      # the server returns 409 (because k8s returns 409) and curl returns 22
      retcode: 22
      stdout: ""
      stderr: ""

- name: "create cronjob with wrong schedule should fail"
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} -f
      json_stdin:
        name: "${CRONJOBNAME}wrong"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
        schedule: "wrong"
      # the server returns 400 (because k8s returns 422) and curl returns 22
      retcode: 22
      stdout: ""
      stderr: ""

- name: "show cronjob, all fields are present"
  tests:
    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${CRONJOBNAME} ${CURL_ARGS})
            echo "$response" | grep -q '"name": "${CRONJOBNAME}"' \
            && echo "$response" | grep -q '"cmd": "${SLEEP_CMD}"' \
            && echo "$response" | grep -q '"image": "${IMG}"' \
            && echo "$response" | grep -q '"image_state": "stable"' \
            && echo "$response" | grep -q '"filelog": "False"' \
            && echo "$response" | grep -q '"filelog_stdout": null' \
            && echo "$response" | grep -q '"filelog_stderr": null' \
            && echo "$response" | grep -q '"retry": 0' \
            && echo "$response" | grep -q "status_short" \
            && echo "$response" | grep -q "status_long" \
            && echo "$response" | grep -q '"emails": "none"' \
            && echo "$response" | grep -F -q '"schedule": "*/10 * * * *"'
      retcode: 0
      stdout: ""
      stderr: ""

- name: "delete cronjob job"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CRONJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

- name: "show cronjob should fail because we just deleted it"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/${CRONJOBNAME} ${CURL_ARGS} -f
      # this means the server returned 404
      retcode: 22
      stdout: ""
      stderr: ""
      retry_attempts: 10

- name: "create 2 cronjobs jobs and delete one by one"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CRONJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        schedule: "*/10 * * * *"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CRONJOBNAME}2"
        imagename: "${IMG}"
        cmd: "true"
        schedule: "*/9 * * * *"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: sleep 10
      # start with a quote to not match 'Waiting for scheduled time' in the status field
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "\"schedule" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/${CRONJOBNAME} ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "\"schedule" | wc -l
      retcode: 0
      stdout: "2"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/${CRONJOBNAME}2 ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

#
# continuous job
#

- name: "create continuous job"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""

- name: "create duplicated continuous job should fail"
  tests:
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: '{"data":{},"message":"A job with the same name exists already"}'
      stderr: ""

- name: "show continuous job, all fields are present"
  tests:
    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${CONTJOBNAME} ${CURL_ARGS})
            echo "$response" | grep -q '"name": "${CONTJOBNAME}"' \
            && echo "$response" | grep -q '"cmd": "true"' \
            && echo "$response" | grep -q '"image": "${IMG}"' \
            && echo "$response" | grep -q '"image_state": "stable"' \
            && echo "$response" | grep -q '"filelog": "False"' \
            && echo "$response" | grep -q '"filelog_stdout": null' \
            && echo "$response" | grep -q '"filelog_stderr": null' \
            && echo "$response" | grep -q '"retry": 0' \
            && echo "$response" | grep -q "status_short" \
            && echo "$response" | grep -q "status_long" \
            && echo "$response" | grep -q '"emails": "none"' \
            && echo "$response" | grep -q '"continuous": true'
      retcode: 0
      stdout: ""
      stderr: ""

- name: "list jobs, only continuous job is present"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep continuous | grep -q true
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep status_short | wc -l
      retcode: 0
      stdout: "1"
      stderr: ""

- name: "delete continuous job"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CONTJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

- name: "show continuous job should fail because we just deleted it"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/${CONTJOBNAME} ${CURL_ARGS} -f
      # this means the server returned 404
      retcode: 22
      stdout: ""
      stderr: ""
      retry_attempts: 10

- name: "create 2 continuous jobs and delete one by one"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}2"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CONTJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "2"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CONTJOBNAME}2" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

#
# mixed cronjob/normaljob/continuousjob
#

- name: "create all 3 types of jobs"
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CRONJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        schedule: "*/10 * * * *"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""

- name: "list jobs, all 3 types are present"
  tests:
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep status_short | wc -l
      retcode: 0
      stdout: "3"
      stderr: ""
      retry_attempts: 10
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep -q schedule
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep -q continuous
      retcode: 0
      stdout: ""
      stderr: ""

- name: "delete cronjob, make sure it doesn't remove the others"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CRONJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10
    # create again the cronjob to do the reverse test
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CRONJOBNAME}"
        imagename: "${IMG}"
        cmd: "true"
        schedule: "*/10 * * * *"
      retcode: 0
      stdout: ""
      stderr: ""

- name: "delete normaljob, make sure it doesn't remove the others"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${JOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10
    # create again the normaljob to continue with tests
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "${SLEEP_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""

- name: "delete continuousjob, make sure it doesn't remove the others"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CONTJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS} | json_pp | grep "image" | wc -l
      retcode: 0
      stdout: "4"
      stderr: ""
      retry_attempts: 10

#
# commands, filelogs, etc
#
- name: job should use default logging method
  tests:
    # create a dummy script that logs something
    - cmd: |
            cat << EOF > ${TOOLHOME}/${LOG_JOB_CMD}
            #!/bin/sh
            echo canary
            echo error-canary >&2
            EOF
    - cmd: chmod a+x ${TOOLHOME}/${LOG_JOB_CMD}
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${LOG_JOB}"
        imagename: "${IMG}"
        cmd: "./${LOG_JOB_CMD}"
        filelog: true
      retcode: 0
      stdout: ""
      stderr: ""
    # verify that canary string has been logged to output log
    - cmd: grep -q "canary" ${TOOLHOME}/${LOG_JOB}.out
      retcode: 0
      retry_attempts: 10
    # verify that error-canary string has been logged to error log
    - cmd: grep -q "error-canary" ${TOOLHOME}/${LOG_JOB}.err
      retcode: 0

- name: job should log canary and error-canary strings to custom-log-file.out
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${LOG_JOB}2"
        imagename: "${IMG}"
        cmd: "./${LOG_JOB_CMD}"
        filelog: true
        filelog_stdout: "${CUSTOM_LOG_FILE}.out"
        filelog_stderr: "${CUSTOM_LOG_FILE}.out"
      retcode: 0
      stdout: ""
      stderr: ""
    # verify that both canary and error-canary strings were logged to custom-log-file.out
    - cmd: grep -q "canary" ${TOOLHOME}/${CUSTOM_LOG_FILE}.out
      retcode: 0
      retry_attempts: 10
    - cmd: grep -q "error-canary" ${TOOLHOME}/${CUSTOM_LOG_FILE}.out
      retcode: 0
    # verify that custom-log-file.err wasn't created
    - cmd: ls ${TOOLHOME}/${CUSTOM_LOG_FILE}.err
      retcode: 2

- name: job should log stdout and stderr to custom log files
  tests:
    # run a job that logs canary string to custom-log-file2.out and error-canary string to custom-log-file.err
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${LOG_JOB}3"
        imagename: "${IMG}"
        cmd: "./${LOG_JOB_CMD}"
        filelog: true
        filelog_stdout: "${CUSTOM_LOG_FILE}2.out"
        filelog_stderr: "${CUSTOM_LOG_FILE}.err"
      retcode: 0
      stdout: ""
      stderr: ""
    # verify that canary string was logged to custom-log-file2.out
    - cmd: grep -q "canary" ${TOOLHOME}/${CUSTOM_LOG_FILE}2.out
      retcode: 0
      retry_attempts: 10
    # verify that error-canary string was logged to custom-log-file.err
    - cmd: grep -q "error-canary" ${TOOLHOME}/${CUSTOM_LOG_FILE}.err
      retcode: 0

- name: job should not produce logs
  tests:
    # verify that a job that uses no_logfile doesn't log
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${LOG_JOB}4"
        imagename: "${IMG}"
        cmd: "./${LOG_JOB_CMD}"
      retcode: 0
      stdout: ""
      stderr: ""
    # wait for the job to run
    - cmd: sleep 60
    # verify the logfiles weren't created
    - cmd: ls ${TOOLHOME}/${LOG_JOB}4.out
      retcode: 2
    - cmd: ls ${TOOLHOME}/${LOG_JOB}4.err
      retcode: 2

#
# CrashLoopBackOff detection
#
- name: job should be detected as crashing
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}"
        imagename: "${IMG}"
        cmd: "exit 1"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""

    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${CONTJOBNAME} ${CURL_ARGS})
            echo "$response" | grep -q '"status_short": "Specified command fails to run"'
      retcode: 0
      stdout: ""
      stderr: ""
      retry_attempts: 10

    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/"${CONTJOBNAME}" ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    # give k8s a chance to do its thing
    - cmd: sleep 60

#
# quota errors
#
- name: quota error reporting
  tests:
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}1"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}2"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}3"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: ""
      stderr: ""
    # quota for continuous jobs created in faketoolforge is 3, this should fail
    - cmd: curl -s --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS} | jq -r '.message'
      json_stdin:
        name: "${CONTJOBNAME}4"
        imagename: "${IMG}"
        cmd: "true"
        continuous: true
      retcode: 0
      stdout: >-
        Out of quota for this kind of job. Please see https://w.wiki/6YLP for details.
      stderr: ""
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/ ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    # give k8s a chance to do its thing
    - cmd: sleep 60

- name: quota job start failures
  tests:
    # 3x4Gi is more than the 8Gi maximum by default
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}-q1"
        imagename: "${IMG}"
        cmd: "sleep 3600"
        continuous: true
        memory: "4Gi"
      retcode: 0
      stdout: ""
      stderr: ""
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}-q2"
        imagename: "${IMG}"
        cmd: "sleep 3600"
        continuous: true
        memory: "4Gi"
      retcode: 0
      stdout: ""
      stderr: ""

    #
    # Continuous job
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${CONTJOBNAME}-q3"
        imagename: "${IMG}"
        cmd: "sleep 3600"
        continuous: true
        memory: "4Gi"
      retcode: 0
      stdout: ""
      stderr: ""

    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${CONTJOBNAME}-q3 ${CURL_ARGS})
            echo "$response" | grep -q '"status_short": "Unable to start, out of quota for memory"'
      retcode: 0
      stdout: ""
      stderr: ""
      retry_attempts: 10

    #
    # Normal job
    - cmd: curl -s -o /dev/null --json @- -X POST ${CURL_URL}/jobs/ ${CURL_ARGS}
      json_stdin:
        name: "${JOBNAME}"
        imagename: "${IMG}"
        cmd: "sleep 3600"
        memory: "4Gi"
      retcode: 0
      stdout: ""
      stderr: ""

    - cmd: |
            response=$(curl -s ${CURL_URL}/jobs/${JOBNAME} ${CURL_ARGS})
            echo "$response" | grep -q '"status_short": "Unable to start, out of quota for memory"'
      retcode: 0
      stdout: ""
      stderr: ""
      retry_attempts: 10

    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/ ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""

#
# cleanup
#
- name: "flush operation all jobs"
  tests:
    - cmd: curl -s -X DELETE ${CURL_URL}/jobs/ ${CURL_ARGS}
      retcode: 0
      stdout: "{}"
      stderr: ""
    - cmd: curl -s ${CURL_URL}/jobs/ ${CURL_ARGS}
      retcode: 0
      stdout: "[]"
      stderr: ""
      retry_attempts: 10
    - cmd: kubectl ${KUBECTL_ARGS} get all
      retcode: 0
      stdout: ""
      stderr: "No resources found in tool-tf-test namespace."
      retry_attempts: 10
